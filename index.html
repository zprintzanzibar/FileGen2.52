<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ZPRINT WO Tool – Ultra Safe v2.4.5</title>
<style>
body{font-family:Arial;padding:20px;max-width:560px}
label{display:block;margin-top:12px}
select,input,button{width:100%;padding:8px;margin-top:4px}
button{margin-top:16px}
#result{margin-top:20px}
</style>
</head>
<body>

<h2>ZPRINT – Work Order Generator</h2>

<form id="woForm">
  <label>Category</label>
  <select id="category" required></select>

  <label>Subcategory</label>
  <select id="subcategory" required></select>

  <label>Client Name</label>
  <input id="client" required>

  <label>Client Phone</label>
  <input list="phoneList" id="phone" required>
  <datalist id="phoneList"></datalist>

  <label>Description</label>
  <input id="description">

  <label>Version</label>
  <input id="version" value="v0">

  <button type="submit">Generate</button>
</form>

<div id="result" style="display:none">
  <p><b>Generated Filename</b></p>
  <input id="filename" readonly>
  <button type="button" onclick="copyFilename()">COPY</button>
  <p><a id="labelLink" target="_blank">Download Job Card Label</a></p>
</div>

<script>
/* ===== FULL CATEGORY LIST ===== */
const CATEGORIES = {
  PVC:{subs:{CLEAR:"Clear",PRC:"Print & Cut",UV:"UV",UVPC:"UV Print & Cut",CUT:"Cutting",PLN:"Plain",GLDC:"Gold Cutting",GLDP:"Gold Plain",ECO:"Eco",CLRPRC:"Clear Print & Cut",FRPL:"Frost Plain",FRCUT:"Frost Cut",FRPRC:"Frost Print & Cut",MAG:"Magnet"}},
  EMB:{subs:{STD:"Standard",PRM:"Premium"}},
  CAN:{subs:{COT:"Cotton",UV:"UV",ECO:"Eco",OTH:"Other"}},
  BAN:{subs:{UV:"UV",ECO:"Eco",TD:"Tear Drop",FECO:"Flag Eco",FUV:"Flag UV",POP:"POP",STD:"Standard",PRM:"Premium"}},
  MAP:{subs:{NRM:"Normal",PP:"PP",POP:"POP"}},
  SUB:{subs:{SUB:"Sublimation"}},
  DTF:{subs:{DTF:"DTF"}},
  CON:{subs:{UV:"UV",ECO:"Eco",PLN:"Plain"}},
  FLT:{subs:{UVD:"UV_DTF",PEN:"Pen",NOTE:"Notebook",ACR:"Acrylic"}},
  PUB:{subs:{FLY:"Flyer",BR:"Brochure",BC:"Business Card",OTH:"Other"}},
  CUS:{subs:{CUS:"Custom Input"}}
};

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyPat4Q7LTdv3985ABPYVeMMeEnVUbsFCIBrzhYOmz2EHcr41JFY3W7GA3JM0cslAaN/exec';

/* ===== DROPDOWNS ===== */
const category = document.getElementById("category");
const subcategory = document.getElementById("subcategory");

category.innerHTML = "<option value=''>Select Category</option>";
subcategory.innerHTML = "<option value=''>Select Subcategory</option>";

Object.keys(CATEGORIES).forEach(c => {
  const o = document.createElement("option");
  o.value = c;
  o.textContent = c;
  category.appendChild(o);
});

category.onchange = () => {
  subcategory.innerHTML = "<option value=''>Select Subcategory</option>";
  const subs = CATEGORIES[category.value]?.subs || {};
  Object.keys(subs).forEach(s => {
    const o = document.createElement("option");
    o.value = s;
    o.textContent = s + " - " + subs[s];
    subcategory.appendChild(o);
  });
};

/* ===== PHONE AUTOSUGGEST ===== */
fetch(`${SCRIPT_URL}?action=getPhones`)
.then(r=>r.json())
.then(data=>{
  const list=document.getElementById("phoneList");
  data.forEach(p=>{
    const o=document.createElement("option");
    o.value=p;
    list.appendChild(o);
  });
})
.catch(()=>{});

/* ===== SUBMIT ===== */
document.getElementById("woForm").onsubmit = async e => {
  e.preventDefault();

  const params = new URLSearchParams({
    action:"createWO",
    category:category.value,
    subcategory:subcategory.value,
    client:client.value,
    phone:phone.value,
    description:description.value,
    version:version.value || "v0"
  });

  try {
    const res = await fetch(`${SCRIPT_URL}?${params}`);
    const data = await res.json();

    if (!data.filename) {
      alert("Error: filename not returned from server");
      return;
    }

// ===== SAFE FINAL FILENAME CONSTRUCTION =====

// Extract reliable values
const woFull = data.wo || "";              // e.g. WO-2025-016
const dateISO = data.date || "";           // e.g. 2025-12-27

// Fallback safety
if (!woFull || !dateISO) {
  alert("Missing WO or Date from server response");
  return;
}

// WO short number
const woNum = woFull.split("-")[2];         // 016

// Date DDMMYY
const [yyyy, mm, dd] = dateISO.split("-");
const shortDate = `${dd}${mm}${yyyy.slice(-2)}`;

// Category & subcategory from form
const cat = category.value;
const sub = subcategory.value;

// Client
const clientName = client.value
  .trim()
  .replace(/\s+/g, "")
  .replace(/[^a-zA-Z0-9_-]/g, "");

// Description
const desc = description.value
  .trim()
  .replace(/\s+/g, "")
  .replace(/[^a-zA-Z0-9_-]/g, "");

// Version
const ver = version.value || "v0";

// FINAL LOCKED FORMAT
const finalFilename =
  `WO${woNum}_${shortDate}_${cat}-${sub}_${clientName}_${desc}_${ver}`;

document.getElementById("filename").value = finalFilename;

    document.getElementById("labelLink").href = data.labelUrl || "#";
    document.getElementById("result").style.display = "block";

  } catch (err) {
    alert("Connection error. Check Apps Script URL.");
  }
};

function copyFilename(){
  const f = document.getElementById("filename");
  f.select();
  f.setSelectionRange(0, 99999);
  document.execCommand("copy");
}
</script>

</body>
</html>
